<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>YTMetrics ‚Äî Channel Intelligence</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f0f0f;--panel:#181818;--muted:#888;--accent:#ff3b3b;
  --accent2:#ffcc00;--success:#4caf50;--card-radius:14px;--gap:14px;
  --text:#f6f6f6;--muted-2:#666;--border:#222;
}
html,body{height:100%;width:100%;overflow-x:hidden}
body{
  font-family:Inter,system-ui,-apple-system,sans-serif;
  background:var(--bg);color:var(--text);
  -webkit-font-smoothing:antialiased;
  overflow-y:auto;overflow-x:hidden;
}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header{
  display:flex;align-items:center;gap:12px;padding:14px 20px;
  position:sticky;top:0;
  background:linear-gradient(180deg,rgba(0,0,0,.85),transparent);
  backdrop-filter:blur(8px);z-index:40;border-bottom:1px solid #1a1a1a;
}
.logo{font-weight:900;font-size:1.1rem;letter-spacing:-0.5px;display:flex;align-items:center;gap:8px}
.logo-icon{width:28px;height:28px;background:var(--accent);border-radius:7px;display:grid;place-items:center;font-size:11px;flex-shrink:0}
.search-box{
  flex:1;max-width:520px;display:flex;
  background:#0d0d0d;border-radius:999px;border:1px solid #222;
  overflow:hidden;align-items:center;padding:4px;
}
.search-box input{
  flex:1;background:transparent;border:0;color:var(--text);
  padding:8px 14px;font-size:.92rem;outline:none;font-family:inherit;
}
.search-box button{
  background:var(--accent);border:0;color:#fff;
  padding:8px 18px;border-radius:999px;cursor:pointer;
  font-weight:800;font-size:.82rem;transition:all .2s;
}
.search-box button:hover{background:#e02020;transform:scale(1.04)}
.header-actions{display:flex;align-items:center;gap:8px;margin-left:auto}
.status{display:flex;align-items:center;gap:8px;background:var(--panel);padding:8px 12px;border-radius:999px;border:1px solid #242424;color:var(--muted);font-size:.82rem}
.dot{width:9px;height:9px;border-radius:50%;background:var(--success);display:inline-block;transition:background .3s}
.dot.loading{background:#ff9800;animation:pulse 1s ease-in-out infinite}
.dot.error{background:var(--accent)}
.icon-btn{width:40px;height:40px;border-radius:10px;background:var(--panel);border:1px solid #222;color:var(--text);display:inline-grid;place-items:center;cursor:pointer;transition:all .18s;font-size:1rem}
.icon-btn:hover{transform:translateY(-2px);border-color:#333}

/* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
.sidebar{position:fixed;right:-360px;top:0;width:360px;height:100vh;background:linear-gradient(180deg,#121212,#0f0f0f);padding:20px;border-left:1px solid #1e1e1e;transition:right .26s cubic-bezier(.2,.9,.2,1);z-index:80;overflow-y:auto}
.sidebar.open{right:0}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:70;display:none;backdrop-filter:blur(2px)}
.overlay.show{display:block}
.sidebar h3{font-size:1rem;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;font-weight:800}
.close{background:none;border:0;color:var(--text);font-size:1.4rem;cursor:pointer;transition:transform .2s}
.close:hover{transform:rotate(90deg)}
.field{margin-bottom:14px}
.field label{display:block;font-size:.72rem;color:var(--muted);margin-bottom:6px;font-weight:700;text-transform:uppercase;letter-spacing:.6px}
.field input,.field textarea,.field select{width:100%;background:transparent;border:1px solid #242424;color:var(--text);padding:10px;border-radius:10px;font-size:.9rem;font-family:inherit;transition:border-color .2s}
.field input:focus,.field textarea:focus,.field select:focus{border-color:var(--accent);outline:none}
.field small{color:var(--muted-2);font-size:.75rem;margin-top:5px;display:block}
.btn{width:100%;padding:12px;border-radius:10px;border:0;font-weight:800;cursor:pointer;margin-top:8px;transition:all .2s;font-family:inherit;font-size:.9rem}
.btn:disabled{opacity:.45;cursor:not-allowed}
.btn:not(:disabled):hover{transform:translateY(-2px)}
.btn-red{background:var(--accent);color:#fff}
.btn-dark{background:#1e1e1e;color:var(--text);border:1px solid #2a2a2a}

/* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
.main{max-width:1320px;margin:20px auto;padding:0 20px}

/* ‚îÄ‚îÄ Summary cards ‚îÄ‚îÄ */
.summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(145px,1fr));gap:12px;margin-bottom:20px;animation:fadeUp .4s ease}
.sum-card{background:linear-gradient(135deg,rgba(255,255,255,.025),rgba(0,0,0,.04));padding:16px;border-radius:12px;border:1px solid #1e1e1e;transition:transform .2s}
.sum-card:hover{transform:translateY(-2px)}
.sum-card .lbl{color:var(--muted);font-size:.68rem;text-transform:uppercase;letter-spacing:.8px;font-weight:700}
.sum-card .val{font-weight:900;font-size:1.4rem;margin-top:6px;letter-spacing:-.03em}

/* ‚îÄ‚îÄ Channel hero ‚îÄ‚îÄ */
.channel-hero{background:linear-gradient(135deg,#141414,#0f0f0f);border:1px solid #1e1e1e;border-radius:var(--card-radius);padding:22px;margin-bottom:20px;display:flex;align-items:center;gap:20px;animation:fadeUp .35s ease}
.chan-avatar{width:72px;height:72px;border-radius:50%;border:3px solid var(--accent);object-fit:cover;flex-shrink:0;background:#1a1a1a}
.chan-name{font-size:1.5rem;font-weight:900;letter-spacing:-.04em}
.chan-handle{font-family:'DM Mono',monospace;font-size:.78rem;color:var(--muted);margin-top:4px}
.chan-desc{font-size:.82rem;color:var(--muted-2);margin-top:6px;line-height:1.5;max-width:500px}
.brand-badge{background:rgba(255,59,59,.1);border:1px solid rgba(255,59,59,.3);color:var(--accent);border-radius:6px;padding:5px 12px;font-size:.72rem;font-weight:800;letter-spacing:.5px;margin-left:auto;flex-shrink:0}

/* ‚îÄ‚îÄ Two col ‚îÄ‚îÄ */
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:20px}

/* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
.card{background:linear-gradient(180deg,#151515,#0f0f0f);border-radius:var(--card-radius);border:1px solid #1e1e1e;padding:20px;animation:fadeUp .4s ease}
.panel-title{font-size:.7rem;font-weight:800;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.panel-title::before{content:'';width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0}

/* ‚îÄ‚îÄ Video list ‚îÄ‚îÄ */
.video-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #1a1a1a}
.video-item:last-child{border-bottom:0}
.rank{font-size:.75rem;font-weight:900;color:#333;width:18px;flex-shrink:0;font-family:'DM Mono',monospace}
.video-thumb{width:64px;height:40px;border-radius:6px;object-fit:cover;border:1px solid #222;flex-shrink:0;background:#1a1a1a}
.video-title{font-size:.82rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.3}
.video-meta{font-family:'DM Mono',monospace;font-size:.7rem;color:var(--muted);margin-top:3px}
.video-views{font-family:'DM Mono',monospace;font-size:.82rem;color:var(--accent2);font-weight:700;flex-shrink:0}

/* ‚îÄ‚îÄ Metric grid ‚îÄ‚îÄ */
.metric-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px}
.metric-card{background:#0d0d0d;border-radius:10px;padding:14px;border:1px solid #1a1a1a;transition:transform .2s,border-color .2s}
.metric-card:hover{transform:translateY(-2px);border-color:#2a2a2a}
.metric-card .metric-label{font-size:.65rem;color:var(--muted-2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;font-weight:700}
.metric-card .metric-value{font-weight:900;font-size:1.3rem;letter-spacing:-.04em}

/* ‚îÄ‚îÄ Bar chart ‚îÄ‚îÄ */
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.bar-label{font-size:.72rem;font-family:'DM Mono',monospace;color:var(--muted);width:130px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bar-track{flex:1;height:6px;background:#1a1a1a;border-radius:999px;overflow:hidden}
.bar-fill{height:100%;border-radius:999px;transition:width .9s cubic-bezier(.16,1,.3,1)}
.bar-val{font-family:'DM Mono',monospace;font-size:.7rem;color:var(--muted);width:42px;text-align:right;flex-shrink:0}
.bar-date{font-family:'DM Mono',monospace;font-size:.68rem;color:#333;width:42px;flex-shrink:0}

/* ‚îÄ‚îÄ Recommendations ‚îÄ‚îÄ */
.rec{display:flex;gap:8px;margin-bottom:8px;align-items:flex-start}
.rec-arrow{color:var(--accent);flex-shrink:0;font-size:.75rem;margin-top:2px;font-weight:900}
.rec-text{font-size:.8rem;color:#777;line-height:1.55}

/* ‚îÄ‚îÄ Report table ‚îÄ‚îÄ */
.report-table{width:100%;border-collapse:collapse}
.report-table th{text-align:left;font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;padding-bottom:10px;border-bottom:1px solid #1e1e1e}
.report-table td{padding:10px 0;border-bottom:1px solid #141414;font-size:.85rem}
.report-table tr:last-child td{border-bottom:0}
.pill{background:#111;border:1px solid #1e1e1e;border-radius:5px;padding:3px 9px;font-family:'DM Mono',monospace;font-size:.78rem}

/* ‚îÄ‚îÄ Empty / loading states ‚îÄ‚îÄ */
#emptyState{padding:80px 20px;text-align:center;color:var(--muted-2)}
#emptyState h3{margin-bottom:8px;font-size:1.1rem;font-weight:700}
.loading-spinner{border:3px solid rgba(255,59,59,.15);border-top-color:var(--accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 16px}

/* ‚îÄ‚îÄ Error box ‚îÄ‚îÄ */
.error-box{background:rgba(255,59,59,.07);border:1px solid rgba(255,59,59,.25);border-radius:10px;padding:12px 16px;font-size:.82rem;color:var(--accent);margin-top:12px;display:none}

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media(max-width:768px){
  .two-col{grid-template-columns:1fr}
  .summary{grid-template-columns:repeat(2,1fr)}
  .channel-hero{flex-wrap:wrap}
  .brand-badge{margin-left:0}
  .sidebar{width:100%;right:-100%}
  .header{flex-wrap:wrap;padding:12px}
  .search-box{max-width:100%}
}
</style>
</head>
<body>
<div id="app">

<!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ -->
<header class="header">
  <div class="logo">
    <div class="logo-icon">‚ñ∂</div>
    YTMetrics
  </div>

  <div class="search-box">
    <input id="channelInput" placeholder="@YourChannel or UCxxxxxxx..." value="@kenazPerfume" aria-label="Channel handle or ID" />
    <button id="analyzeBtn" onclick="startAnalysis()">Analyze ‚Üí</button>
  </div>

  <div class="header-actions">
    <div class="status">
      <span class="dot" id="dot"></span>
      <span id="statusTxt">Ready</span>
    </div>
    <button class="icon-btn" id="refreshBtn" title="Refresh" onclick="if(window._lastChannel)startAnalysis()">‚Üª</button>
    <button class="icon-btn" id="settingsBtn" title="Settings">‚öô</button>
  </div>
</header>

<!-- ‚îÄ‚îÄ Overlay ‚îÄ‚îÄ -->
<div class="overlay" id="overlay"></div>

<!-- ‚îÄ‚îÄ Settings Sidebar ‚îÄ‚îÄ -->
<aside class="sidebar" id="sidebar">
  <h3>Settings <button class="close" id="closeSidebar">√ó</button></h3>

  <div class="field">
    <label>YouTube API Key</label>
    <input type="password" id="apiKeyInput" placeholder="AIza... (stored in your env)" autocomplete="off">
    <small>Key is sent to your server ‚Äî never exposed in browser.</small>
  </div>

  <div class="field">
    <label>Default Channel</label>
    <input type="text" id="defaultChannel" placeholder="@YourBrand or UCxxxxxxx">
    <small>Pre-fills the search bar on load.</small>
  </div>

  <div class="field">
    <label>Max Videos to Fetch</label>
    <select id="maxVideos">
      <option value="10">10 videos</option>
      <option value="25" selected>25 videos</option>
      <option value="50">50 videos</option>
    </select>
  </div>

  <button class="btn btn-red" onclick="startAnalysis(); closeSidebar()">‚ñ∂ Analyze Channel</button>
  <button class="btn btn-dark" id="saveSettingsBtn">üíæ Save Settings</button>
</aside>

<!-- ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ -->
<main class="main">
  <div id="emptyState">
    <div style="font-size:3rem;margin-bottom:16px">‚ñ∂</div>
    <h3>Enter a YouTube Channel</h3>
    <p>Type a channel handle or ID in the search bar above to load analytics</p>
  </div>

  <div id="loadingState" style="display:none;padding:80px 20px;text-align:center">
    <div class="loading-spinner"></div>
    <div style="font-family:'DM Mono',monospace;font-size:.85rem;color:var(--muted)" id="loadingText">Fetching channel data...</div>
    <div style="font-family:'DM Mono',monospace;font-size:.72rem;color:#333;margin-top:6px">via YouTube Data API v3</div>
  </div>

  <div class="error-box" id="errorBox"></div>

  <!-- Results injected here -->
  <div id="results" style="display:none">

    <!-- Channel Hero -->
    <div class="channel-hero">
      <img id="chanAvatar" src="" class="chan-avatar" onerror="this.style.display='none'" alt="Channel avatar">
      <div style="flex:1;min-width:0">
        <div class="chan-name" id="chanName">‚Äî</div>
        <div class="chan-handle" id="chanHandle">‚Äî</div>
        <div class="chan-desc" id="chanDesc"></div>
      </div>
      <div class="brand-badge">BRAND CHANNEL</div>
    </div>

    <!-- Summary Row -->
    <div class="summary" id="summary"></div>

    <!-- Two-col: Top Videos + Engagement -->
    <div class="two-col">
      <div class="card">
        <div class="panel-title">Top Videos by Views</div>
        <div id="topVideos"></div>
      </div>
      <div class="card">
        <div class="panel-title">Engagement Metrics</div>
        <div class="metric-grid" id="engMetrics"></div>
        <div class="panel-title" style="margin-top:4px">Team Recommendations</div>
        <div id="recommendations"></div>
      </div>
    </div>

    <!-- Bar Chart -->
    <div class="card" style="margin-bottom:20px">
      <div class="panel-title">View Performance ‚Äî All Videos</div>
      <div id="barChart"></div>
    </div>

    <!-- Report Table -->
    <div class="card" style="margin-bottom:40px">
      <div class="panel-title">Influencer Team Report Card</div>
      <table class="report-table">
        <thead>
          <tr>
            <th>Metric</th><th>Value</th><th>Health</th><th>Team Action</th>
          </tr>
        </thead>
        <tbody id="reportBody"></tbody>
      </table>
    </div>

  </div><!-- /results -->
</main>
</div><!-- /app -->

<script>
'use strict';

/* ‚îÄ‚îÄ Utils ‚îÄ‚îÄ */
const fmt = n => {
  n = parseInt(n);
  if (isNaN(n)) return '‚Äî';
  if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toLocaleString();
};
const pct  = (a, b) => b > 0 ? (a / b * 100).toFixed(2) : '0';
const hclr = (v, lo, hi) => parseFloat(v) >= hi ? 'var(--success)' : parseFloat(v) >= lo ? 'var(--accent2)' : 'var(--accent)';
const hlbl = (v, lo, hi) => parseFloat(v) >= hi ? '‚úì Strong' : parseFloat(v) >= lo ? '~ Average' : '‚Üì Low';

/* ‚îÄ‚îÄ DOM shortcuts ‚îÄ‚îÄ */
const $ = id => document.getElementById(id);

/* ‚îÄ‚îÄ Status ‚îÄ‚îÄ */
function setStatus(text, type = 'success') {
  $('statusTxt').textContent = text;
  const dot = $('dot');
  dot.className = 'dot' + (type === 'loading' ? ' loading' : type === 'error' ? ' error' : '');
}

/* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
function openSidebar()  { $('sidebar').classList.add('open');    $('overlay').classList.add('show'); }
function closeSidebar() { $('sidebar').classList.remove('open'); $('overlay').classList.remove('show'); }

/* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
function showError(msg) {
  const el = $('errorBox');
  el.textContent = '‚ö† ' + msg;
  el.style.display = 'block';
  $('loadingState').style.display = 'none';
  $('analyzeBtn').disabled = false;
  setStatus('Error', 'error');
}
function clearError() { $('errorBox').style.display = 'none'; }

/* ‚îÄ‚îÄ API proxy call via server.js ‚îÄ‚îÄ */
async function yt(endpoint, params) {
  const url = new URL('/api/youtube', location.origin);
  url.searchParams.set('endpoint', endpoint);
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));

  const apiKey = $('apiKeyInput').value.trim();
  if (apiKey) url.searchParams.set('_clientKey', apiKey); // optional: pass key from UI

  const res  = await fetch(url.toString());
  const data = await res.json();
  if (data.error) throw new Error(data.error.message || JSON.stringify(data.error));
  return data;
}

/* ‚îÄ‚îÄ Settings persistence ‚îÄ‚îÄ */
function saveSettings() {
  try {
    localStorage.setItem('ytm_apikey',  $('apiKeyInput').value.trim());
    localStorage.setItem('ytm_defchan', $('defaultChannel').value.trim());
    localStorage.setItem('ytm_maxvids', $('maxVideos').value);
    alert('‚úÖ Settings saved!');
  } catch(e) {}
}
function loadSettings() {
  try {
    const k = localStorage.getItem('ytm_apikey');
    const c = localStorage.getItem('ytm_defchan');
    const m = localStorage.getItem('ytm_maxvids');
    if (k) $('apiKeyInput').value  = k;
    if (c) { $('defaultChannel').value = c; $('channelInput').value = c; }
    if (m) $('maxVideos').value = m;
  } catch(e) {}
}

/* ‚îÄ‚îÄ Main analysis ‚îÄ‚îÄ */
async function startAnalysis() {
  const raw = $('channelInput').value.trim();
  if (!raw) return showError('Please enter a channel handle or ID.');

  clearError();
  $('results').style.display     = 'none';
  $('emptyState').style.display  = 'none';
  $('loadingState').style.display = 'block';
  $('analyzeBtn').disabled = true;
  setStatus('Loading...', 'loading');
  window._lastChannel = raw;

  try {
    const maxResults = parseInt($('maxVideos').value) || 25;
    const handle     = raw.replace(/^@/, '');

    /* Step 1 ‚Äî Channel info */
    $('loadingText').textContent = 'Step 1/4 ‚Äî Fetching channel info...';
    let chanData;
    if (raw.startsWith('UC')) {
      chanData = await yt('channels', { part: 'snippet,statistics,contentDetails', id: raw });
    } else {
      chanData = await yt('channels', { part: 'snippet,statistics,contentDetails', forHandle: handle });
    }
    if (!chanData.items?.length) {
      const s = await yt('search', { part: 'snippet', type: 'channel', q: handle, maxResults: 1 });
      if (!s.items?.length) throw new Error('Channel not found. Try the Channel ID (starts with UC...).');
      chanData = await yt('channels', { part: 'snippet,statistics,contentDetails', id: s.items[0].id.channelId });
    }
    if (!chanData.items?.length) throw new Error('Channel not found.');

    const ch          = chanData.items[0];
    const stats       = ch.statistics;
    const snip        = ch.snippet;
    const uploadsId   = ch.contentDetails?.relatedPlaylists?.uploads;
    if (!uploadsId) throw new Error('Could not find uploads playlist.');

    /* Step 2 ‚Äî Video list */
    $('loadingText').textContent = 'Step 2/4 ‚Äî Loading video list...';
    const pl       = await yt('playlistItems', { part: 'contentDetails', playlistId: uploadsId, maxResults });
    const videoIds = (pl.items || []).map(i => i.contentDetails?.videoId).filter(Boolean);
    if (!videoIds.length) throw new Error('No videos found on this channel.');

    /* Step 3 ‚Äî Video stats */
    $('loadingText').textContent = 'Step 3/4 ‚Äî Fetching video statistics...';
    const vs     = await yt('videos', { part: 'statistics,snippet', id: videoIds.join(',') });
    const videos = (vs.items || []).map(v => ({
      title:    v.snippet?.title || 'Untitled',
      thumb:    v.snippet?.thumbnails?.medium?.url || v.snippet?.thumbnails?.default?.url || '',
      date:     (v.snippet?.publishedAt || '').slice(0, 7),
      views:    parseInt(v.statistics?.viewCount)    || 0,
      likes:    parseInt(v.statistics?.likeCount)    || 0,
      comments: parseInt(v.statistics?.commentCount) || 0,
    })).sort((a, b) => b.views - a.views);

    /* Step 4 ‚Äî Compute */
    $('loadingText').textContent = 'Step 4/4 ‚Äî Computing insights...';
    const tv        = videos.reduce((s, v) => s + v.views,    0);
    const tl        = videos.reduce((s, v) => s + v.likes,    0);
    const tc        = videos.reduce((s, v) => s + v.comments, 0);
    const avgViews  = videos.length ? Math.round(tv / videos.length) : 0;
    const likeRate  = pct(tl, tv);
    const comRate   = (+pct(tc, tv)).toFixed(3);
    const engRate   = pct(tl + tc, tv);
    const subs      = parseInt(stats.subscriberCount) || 0;

    /* ‚îÄ‚îÄ Render: Channel hero ‚îÄ‚îÄ */
    $('chanAvatar').src  = snip.thumbnails?.high?.url || snip.thumbnails?.default?.url || '';
    $('chanName').textContent    = snip.title || '';
    $('chanHandle').textContent  = (snip.customUrl || `@${handle}`) + (snip.country ? ` ¬∑ ${snip.country}` : '');
    $('chanDesc').textContent    = (snip.description || '').slice(0, 140) + (snip.description?.length > 140 ? '‚Ä¶' : '');

    /* ‚îÄ‚îÄ Summary row ‚îÄ‚îÄ */
    $('summary').innerHTML = [
      { lbl: 'Subscribers',     val: stats.hiddenSubscriberCount ? 'Hidden' : fmt(stats.subscriberCount), color: 'var(--text)' },
      { lbl: 'Total Views',     val: fmt(stats.viewCount),  color: 'var(--accent2)' },
      { lbl: 'Videos Published', val: fmt(stats.videoCount), color: 'var(--text)' },
      { lbl: 'Avg Views / Video', val: fmt(avgViews),        color: 'var(--success)' },
      { lbl: 'Total Likes',     val: fmt(tl),                color: 'var(--text)' },
      { lbl: 'Total Comments',  val: fmt(tc),                color: 'var(--text)' },
    ].map(s => `
      <div class="sum-card">
        <div class="lbl">${s.lbl}</div>
        <div class="val" style="color:${s.color}">${s.val}</div>
      </div>`).join('');

    /* ‚îÄ‚îÄ Top 5 videos ‚îÄ‚îÄ */
    $('topVideos').innerHTML = videos.slice(0, 5).map((v, i) => `
      <div class="video-item">
        <div class="rank">#${i + 1}</div>
        <img class="video-thumb" src="${v.thumb}" onerror="this.style.display='none'" alt="">
        <div style="flex:1;min-width:0">
          <div class="video-title">${escHtml(v.title)}</div>
          <div class="video-meta">üëç ${fmt(v.likes)} üí¨ ${fmt(v.comments)} ¬∑ ${v.date}</div>
        </div>
        <div class="video-views">${fmt(v.views)}</div>
      </div>`).join('');

    /* ‚îÄ‚îÄ Engagement metrics ‚îÄ‚îÄ */
    $('engMetrics').innerHTML = [
      { lbl: 'Engagement Rate', val: engRate + '%',  color: hclr(engRate, 2, 4) },
      { lbl: 'Like Rate',       val: likeRate + '%', color: hclr(likeRate, 2, 4) },
      { lbl: 'Comment Rate',    val: comRate + '%',  color: hclr(comRate, .05, .2) },
      { lbl: 'Total Likes',     val: fmt(tl),         color: 'var(--text)' },
    ].map(m => `
      <div class="metric-card">
        <div class="metric-label">${m.lbl}</div>
        <div class="metric-value" style="color:${m.color}">${m.val}</div>
      </div>`).join('');

    /* ‚îÄ‚îÄ Recommendations ‚îÄ‚îÄ */
    const recs = [
      subs < 10000   && 'Grow subscribers via influencer collabs & paid promotions',
      parseFloat(likeRate) < 2  && 'Add like CTAs at the 30s mark and end screen',
      parseFloat(comRate)  < .1 && 'Ask questions in video to drive comment engagement',
      avgViews < 1000 && 'Improve SEO: keyword-rich titles, tags & descriptions',
      'Reply to every comment within the first hour of posting',
      'A/B test thumbnail styles ‚Äî faces & bold text perform best',
    ].filter(Boolean).slice(0, 4);
    $('recommendations').innerHTML = recs.map(r => `
      <div class="rec"><div class="rec-arrow">‚Üí</div><div class="rec-text">${r}</div></div>`).join('');

    /* ‚îÄ‚îÄ Bar chart ‚îÄ‚îÄ */
    const maxV = videos[0]?.views || 1;
    $('barChart').innerHTML = videos.map((v, i) => `
      <div class="bar-row">
        <div class="bar-label" title="${escHtml(v.title)}">${escHtml(v.title)}</div>
        <div class="bar-track">
          <div class="bar-fill" style="width:0%;background:${i === 0 ? 'var(--accent)' : '#2a2a2a'}" data-w="${(v.views / maxV * 100).toFixed(1)}"></div>
        </div>
        <div class="bar-val">${fmt(v.views)}</div>
        <div class="bar-date">${v.date}</div>
      </div>`).join('');
    setTimeout(() => {
      document.querySelectorAll('.bar-fill').forEach(el => { el.style.width = el.dataset.w + '%'; });
    }, 120);

    /* ‚îÄ‚îÄ Report table ‚îÄ‚îÄ */
    $('reportBody').innerHTML = [
      { l: 'Subscribers',      v: stats.hiddenSubscriberCount ? 'Hidden' : fmt(subs),   raw: subs,              lo: 10000, hi: 100000, a: 'Run giveaways & influencer collabs' },
      { l: 'Total Views',      v: fmt(parseInt(stats.viewCount)),                         raw: parseInt(stats.viewCount), lo: 100000, hi: 1e6, a: 'Repurpose top videos as Shorts' },
      { l: 'Avg Views / Video',v: fmt(avgViews),                                          raw: avgViews,          lo: 1000,  hi: 10000,  a: 'Boost hero content with paid ads' },
      { l: 'Engagement Rate',  v: engRate + '%',                                          raw: engRate,           lo: 2,     hi: 4,      a: 'Add polls & community posts weekly' },
      { l: 'Like Rate',        v: likeRate + '%',                                         raw: likeRate,          lo: 2,     hi: 4,      a: 'Place CTA at 30% & 80% of video' },
      { l: 'Comment Rate',     v: comRate + '%',                                          raw: comRate,           lo: .05,   hi: .2,     a: 'Reply to all comments in first 24hr' },
      { l: 'Total Videos',     v: fmt(parseInt(stats.videoCount)),                        raw: parseInt(stats.videoCount), lo: 20, hi: 100, a: 'Aim for consistent weekly uploads' },
    ].map(r => `
      <tr>
        <td style="font-weight:700">${r.l}</td>
        <td><span class="pill">${r.v}</span></td>
        <td style="font-weight:800;color:${hclr(r.raw, r.lo, r.hi)}">${hlbl(r.raw, r.lo, r.hi)}</td>
        <td style="font-size:.78rem;color:var(--muted)">${r.a}</td>
      </tr>`).join('');

    /* ‚îÄ‚îÄ Show results ‚îÄ‚îÄ */
    $('loadingState').style.display = 'none';
    $('results').style.display      = 'block';
    setStatus(`${videos.length} videos analyzed`, 'success');

  } catch (e) {
    console.error(e);
    showError(e.message || 'Something went wrong.');
  }

  $('analyzeBtn').disabled = false;
}

/* ‚îÄ‚îÄ HTML escape ‚îÄ‚îÄ */
function escHtml(s) {
  return String(s || '').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ */
document.getElementById('settingsBtn').onclick  = openSidebar;
document.getElementById('closeSidebar').onclick = closeSidebar;
document.getElementById('overlay').onclick      = closeSidebar;
document.getElementById('saveSettingsBtn').onclick = saveSettings;
document.getElementById('channelInput').addEventListener('keypress', e => {
  if (e.key === 'Enter') startAnalysis();
});

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
loadSettings();
</script>
</body>
</html>
